{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Stack for OpenMRS servers backups",
  "Resources" : {
    "openmrsbackup" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName" : "openmrs-backups",
        "LifecycleConfiguration": {
          "Rules": [{
             "Id": "archive-and-delete",
             "Status": "Enabled",
             "ExpirationInDays": 180,
             "Transitions": [{
                "StorageClass" : "GLACIER",
                "TransitionInDays" : 30
              }]
            }]
         }
      }
    },
    "openmrstalkbackup" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName" : "openmrs-talk-backup",
        "LifecycleConfiguration": {
          "Rules": [{
             "Id": "archive-and-delete",
             "Status": "Enabled",
             "ExpirationInDays": 180,
             "Transitions": [{
                "StorageClass" : "GLACIER",
                "TransitionInDays" : 30
            }]
          }]
        }
      }
    },
    "openmrsmanualbackup" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName" : "openmrs-manual-backup"
        }
    },
    "openmrsbackupbucketpolicy" : {
       "Type" : "AWS::S3::BucketPolicy",
       "Properties" : {
          "PolicyDocument" : {
             "Id" : "allow-backup-upload",
             "Version": "2012-10-17",
             "Statement" : [ {
               "Sid" : "UploadAccessBafoussam",
               "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
               "Effect" : "Allow",
               "Resource" : { "Fn::Join" : [
                     "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/bafoussam/*" ]
                  ] },
               "Principal" : {
                  "AWS" : { "Fn::GetAtt" : [ "bafoussamuser", "Arn" ] }
               }
            },
            {
               "Sid" : "UploadAccessBamenda",
               "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
               "Effect" : "Allow",
               "Resource" : { "Fn::Join" : [
                     "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/bamenda/*" ]
                  ] },
               "Principal" : {
                  "AWS" : { "Fn::GetAtt" : [ "bamendauser", "Arn" ] }
               }
            },
            {
              "Sid" : "UploadAccessBanyo",
              "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
              "Effect" : "Allow",
              "Resource" : { "Fn::Join" : [
                    "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/banyo/*" ]
                 ] },
              "Principal" : {
                 "AWS" : { "Fn::GetAtt" : [ "banyouser", "Arn" ] }
              }
           },
           {
             "Sid" : "UploadAccessBatouri",
             "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
             "Effect" : "Allow",
             "Resource" : { "Fn::Join" : [
                   "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/batouri/*" ]
                ] },
             "Principal" : {
                "AWS" : { "Fn::GetAtt" : [ "batouriuser", "Arn" ] }
             }
           },
           {
             "Sid" : "UploadAccessYaounde",
             "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
             "Effect" : "Allow",
             "Resource" : { "Fn::Join" : [
                   "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/yaounde/*" ]
                ] },
             "Principal" : {
                "AWS" : { "Fn::GetAtt" : [ "yaoundeuser", "Arn" ] }
             }
           },
           {
             "Sid" : "UploadAccessElk",
             "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
             "Effect" : "Allow",
             "Resource" : { "Fn::Join" : [
                   "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/elk/*" ]
                ] },
             "Principal" : {
                "AWS" : { "Fn::GetAtt" : [ "elkuser", "Arn" ] }
             }
           },
           {
             "Sid" : "UploadAccessNdu",
             "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
             "Effect" : "Allow",
             "Resource" : { "Fn::Join" : [
                   "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/ndu/*" ]
                ] },
             "Principal" : {
                "AWS" : { "Fn::GetAtt" : [ "nduuser", "Arn" ] }
             }
          },
          {
            "Sid" : "UploadAccessGarissa",
            "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
            "Effect" : "Allow",
            "Resource" : { "Fn::Join" : [
                  "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/garissa/*" ]
               ] },
            "Principal" : {
               "AWS" : { "Fn::GetAtt" : [ "garissauser", "Arn" ] }
            }
          },
          {
            "Sid" : "UploadAccessLamu",
            "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
            "Effect" : "Allow",
            "Resource" : { "Fn::Join" : [
                  "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/lamu/*" ]
               ] },
            "Principal" : {
               "AWS" : { "Fn::GetAtt" : [ "lamuuser", "Arn" ] }
            }
          },
          {
            "Sid" : "UploadAccessThika",
            "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
            "Effect" : "Allow",
            "Resource" : { "Fn::Join" : [
                  "", [ "arn:aws:s3:::", { "Ref" : "openmrsbackup" } , "/thika/*" ]
               ] },
            "Principal" : {
               "AWS" : { "Fn::GetAtt" : [ "thikauser", "Arn" ] }
            }
          }]
        },
        "Bucket" : { "Ref" : "openmrsbackup" }
       }
    },
    "openmrstalkbackupbucketpolicy" : {
       "Type" : "AWS::S3::BucketPolicy",
       "Properties" : {
          "PolicyDocument" : {
             "Id" : "allow-backup-upload",
             "Version": "2012-10-17",
             "Statement" : [{
                "Sid" : "UploadAccesstalk",
                "Action" : [ "s3:PutObject", "s3:ListMultipartUploadParts", "s3:AbortMultipartUpload" ],
                "Effect" : "Allow",
                "Resource" : { "Fn::Join" : [
                      "", [ "arn:aws:s3:::", { "Ref" : "openmrstalkbackup" } , "/*" ]
                   ] },
                "Principal" : {
                   "AWS" : { "Fn::GetAtt" : [ "talkuser", "Arn" ] }
                }
             }]
          },
        "Bucket" : { "Ref" : "openmrstalkbackup" }
       }
    },
    "bafoussamuser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "bafoussam-backups"
      }
    },
    "bafoussamkey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "bafoussamuser" }
       }
    },
    "bamendauser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "bamenda-backups"
      }
    },
    "bamendakey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "bamendauser" }
       }
    },
    "banyouser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "banyo-backups"
      }
    },
    "banyokey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "banyouser" }
       }
    },
    "batouriuser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "batouri-backups"
      }
    },
    "batourikey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "batouriuser" }
       }
    },
    "talkuser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "talk-backups"
      }
    },
    "talkkey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "talkuser" }
       }
    },
    "nduuser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "ndu-backups"
      }
    },
    "ndukey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "nduuser" }
       }
    },
    "yaoundeuser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "yaounde-backups"
      }
    },
    "yaoundekey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "yaoundeuser" }
       }
    },
    "elkuser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "elk-backups"
      }
    },
    "elkkey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "elkuser" }
       }
    },
    "garissauser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "garissa-backups"
      }
    },
    "garissakey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "garissauser" }
       }
    },
    "lamuuser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "lamu-backups"
      }
    },
    "lamukey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "lamuuser" }
       }
    },
    "thikauser" : {
      "Type": "AWS::IAM::User",
      "Properties": {
        "UserName": "thika-backups"
      }
    },
    "thikakey": {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "UserName": { "Ref" : "thikauser" }
       }
    }
  },
  "Outputs" : {
    "bafoussamaccesskey" : {
      "Description": " AccessKeyId for bafoussam",
      "Value" : { "Ref" : "bafoussamkey" }
    },
    "bafoussamsecretkey" : {
      "Description": "SecretAccessKey for bafoussam",
      "Value" : { "Fn::GetAtt" : [ "bafoussamkey", "SecretAccessKey" ]}
    },
    "bamendaaccesskey" : {
      "Description": " AccessKeyId for bamenda",
      "Value" : { "Ref" : "bamendakey" }
    },
    "bamendasecretkey" : {
      "Description": "SecretAccessKey for bamenda",
      "Value" : { "Fn::GetAtt" : [ "bamendakey", "SecretAccessKey" ]}
    },
    "banyoaccesskey" : {
      "Description": " AccessKeyId for banyo",
      "Value" : { "Ref" : "banyokey" }
    },
    "banyosecretkey" : {
      "Description": "SecretAccessKey for banyo",
      "Value" : { "Fn::GetAtt" : [ "banyokey", "SecretAccessKey" ]}
    },
    "batouriaccesskey" : {
      "Description": " AccessKeyId for batouri",
      "Value" : { "Ref" : "batourikey" }
    },
    "batourisecretkey" : {
      "Description": "SecretAccessKey for batouri",
      "Value" : { "Fn::GetAtt" : [ "batourikey", "SecretAccessKey" ]}
    },
    "talkaccesskey" : {
      "Description": " AccessKeyId for talk",
      "Value" : { "Ref" : "talkkey" }
    },
    "talksecretkey" : {
      "Description": "SecretAccessKey for talk",
      "Value" : { "Fn::GetAtt" : [ "talkkey", "SecretAccessKey" ]}
    },
    "nduaccesskey" : {
      "Description": " AccessKeyId for ndu",
      "Value" : { "Ref" : "ndukey" },
    },
    "ndusecretkey" : {
      "Description": "SecretAccessKey for ndu",
      "Value" : { "Fn::GetAtt" : [ "ndukey", "SecretAccessKey" ]}
    },
    "yaoundeaccesskey" : {
      "Description": " AccessKeyId for yaounde",
      "Value" : { "Ref" : "yaoundekey" }
    },
    "yaoundesecretkey" : {
      "Description": "SecretAccessKey for yaounde",
      "Value" : { "Fn::GetAtt" : [ "yaoundekey", "SecretAccessKey" ]}
    },
    "elkaccesskey" : {
      "Description": " AccessKeyId for elk",
      "Value" : { "Ref" : "elkkey" }
    },
    "elksecretkey" : {
      "Description": "SecretAccessKey for elk",
      "Value" : { "Fn::GetAtt" : [ "elkkey", "SecretAccessKey" ]}
    },
    "garissaaccesskey" : {
      "Description": " AccessKeyId for garissa",
      "Value" : { "Ref" : "garissakey" }
    },
    "garissasecretkey" : {
      "Description": "SecretAccessKey for garissa",
      "Value" : { "Fn::GetAtt" : [ "garissakey", "SecretAccessKey" ]}
    },
    "lamuaccesskey" : {
      "Description": " AccessKeyId for lamu",
      "Value" : { "Ref" : "lamukey" }
    },
    "lamusecretkey" : {
      "Description": "SecretAccessKey for lamu",
      "Value" : { "Fn::GetAtt" : [ "lamukey", "SecretAccessKey" ]}
    },
    "thikaaccesskey" : {
      "Description": " AccessKeyId for thika",
      "Value" : { "Ref" : "thikakey" }
    },
    "thikasecretkey" : {
      "Description": "SecretAccessKey for thika",
      "Value" : { "Fn::GetAtt" : [ "thikakey", "SecretAccessKey" ]}
    }
  }
}
