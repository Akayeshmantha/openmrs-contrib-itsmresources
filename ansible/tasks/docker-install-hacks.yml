---
  - name: Adding dd-agent to docker group
    user: name='dd-agent'
          groups='docker'
          append=yes
  # https://github.com/docker/compose/issues/4344
  - name: Check if docker-py is installed
    command: pip list | fgrep 'docker-py '
    register: docker_py_installed
    changed_when: docker_py_installed.stdout.find('docker-py') == -1
  - name: Uninstall docker-py
    shell: pip uninstall docker docker-py ; pip install docker==2.0.1
    when: docker_py_installed.stdout.find('docker-py') == -1

  - name: Check if docker was restarted yet
    command: docker info
    register: docker_restarted
    changed_when: docker_restarted.stdout.find('overlay2') == -1
  - name: Restart docker service
    shell: systemctl restart docker
    when: docker_restarted.stdout.find('overlay2') == -1

  - name: Check if datadog-agent was restarted yet
    command: dd-agent info
    register: datadog_restarted_docker
    changed_when: datadog_restarted_docker.stdout.find('Initialization failed. Will retry at next iteration') != -1
  - name: Restart datadog-agent service
    shell: systemctl restart datadog-agent
    when: datadog_restarted_docker.stdout.find('Initialization failed. Will retry at next iteration') != -1

  - name: Docker cleanup script copy
    copy:
      src: 'files/docker-cleanup.sh'
      dest: "/usr/sbin/docker-cleanup.sh"
      owner: 'root'
      group: 'root'
      mode: '0700'
  - name: Docker cleanup cron
    cron:
      name: "docker-cleanup"
      minute: "0"
      hour: "2"
      job: "/usr/sbin/docker-cleanup.sh"
